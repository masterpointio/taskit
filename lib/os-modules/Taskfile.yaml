version: "3"

vars:
  DEFAULT_MODULES: |
    terraform-aws-ssm-agent \
    terraform-aws-tailscale \
    terraform-aws-identity-center-users \
    terraform-datadog-users \
    terraform-github-teams \
    terraform-googleworkspace-users-groups-automation \
    terraform-postgres-config-dbs-users-roles \
    terraform-secrets-helper \
    terraform-spacelift-automation \
    terraform-spacelift-aws-integrations \
    terraform-spacelift-events-collector-audit-trail \
    terraform-spacelift-policies

  # Configuration constants
  SYNC_BRANCH: chore/sync-with-template
  SHARED_TMP_DIR: .tmp-template-sync
  TEMPLATE_REPO: https://github.com/masterpointio/terraform-module-template.git
  TEMPLATE_OWNER: masterpointio
  SYNC_MESSAGE: "chore: sync with latest template state"

  # Files to synchronize
  SYNC_FILES: >-
    .checkov.yaml
    .coderabbit.yaml
    .editorconfig
    .gitignore
    .github
    .markdownlint.yaml
    .terraform-docs.yaml
    .tflint.hcl
    .trunk
    .yamllint.yaml
    LICENSE
    aqua.yaml
tasks:
  # ============================================================================
  # File Synchronization Tasks
  # ============================================================================

  sync:
    desc: |
      Sync files from `terraform-module-template` to specified Terraform open-source module repos.
      Example: `task os:sync -- terraform-spacelift-automation`
    summary: |
      This will sync the specified list of files and directories from the remote template repository
      to each of the default Terraform module repositories listed in DEFAULT_MODULES.
      The task will synchronize the hardoded list of common files and directories.
      To sync to a specific repository (or a custom list of repositories), pass their names as arguments:
      `task os:sync -- terraform-custom-module`
      or for multiple modules: `task os:sync -- "terraform-custom-module terraform-another-module"`

    vars:
      MODULES: "{{if .CLI_ARGS}}{{.CLI_ARGS}}{{else}}{{.DEFAULT_MODULES}}{{end}}"
    cmds:
      - |
        # Convert newlines to spaces and remove backslashes
        modules=$(echo "{{.MODULES}}" | tr '\n' ' ' | sed 's/\\//g')
        for module in $modules
        do
          echo "Syncing files to ../$module ..."
          for file in {{.SYNC_FILES}}
          do
            echo "  Syncing $file"
            rsync -av --delete {{.SHARED_TMP_DIR}}/$file ../$module/
          done
        done

  # ============================================================================
  # Git Branch Management Tasks
  # ============================================================================

  pull-and-branch:
    desc: |
      Pull main branch and create a sync branch for specified Terraform open-source module repos.
      Example: `task os:pull-and-branch -- terraform-spacelift-automation`
    summary: |
      This will pull the main branch and create a new branch named 'chore/sync-with-template'
      for each of the default Terraform module repositories listed in DEFAULT_MODULES.
      To sync to a specific repository (or a custom list of repositories), pass their names as arguments:
      `task os:pull-and-branch -- terraform-custom-module`
      or for multiple modules: `task os:pull-and-branch -- "terraform-custom-module terraform-another-module"`

    vars:
      MODULES: "{{if .CLI_ARGS}}{{.CLI_ARGS}}{{else}}{{.DEFAULT_MODULES}}{{end}}"
      DELETE_EXISTING_SYNC_BRANCH: "{{.DELETE_EXISTING_SYNC_BRANCH | default false}}"
    cmds:
      - |
        # Convert newlines to spaces and remove backslashes
        modules=$(echo "{{.MODULES}}" | tr '\n' ' ' | sed 's/\\//g')
        for module in $modules
        do
          echo -e "\n\nðŸš€ Processing ---------------- $module \n"
          if [ ! -d ../$module ]; then
            echo "ðŸ§² Cloning repository..."
            git clone "git@github.com:{{.TEMPLATE_OWNER}}/$module.git" ../$module
          fi
          cd ../$module

          echo "â¬‡ï¸  Pulling main branch..."
          git checkout main
          git pull origin main

          echo "ðŸ”„ Creating sync branch ..."

          # If branch exists and delete option is turned off - skip creation
          if git branch --list "{{.SYNC_BRANCH}}" | grep -q "{{.SYNC_BRANCH}}" && [ "{{.DELETE_EXISTING_SYNC_BRANCH}}" = "false" ]; then
            echo "â­ï¸  Branch {{.SYNC_BRANCH}} already exists, checking it out."
            git checkout {{.SYNC_BRANCH}}

            # Check if local and remote branches have diverged
            if git status --porcelain -b | grep -q "ahead\|behind\|diverged"; then
              echo "âš ï¸  Local and remote branches have diverged. Resetting to remote branch..."
              git fetch origin {{.SYNC_BRANCH}}
              git reset --hard origin/{{.SYNC_BRANCH}}
            fi

          # If branch exists and delete option is turned on - delete and create new branch
          elif git branch --list "{{.SYNC_BRANCH}}" | grep -q "{{.SYNC_BRANCH}}" && [ "{{.DELETE_EXISTING_SYNC_BRANCH}}" = "true" ]; then
            echo "â­ï¸  Branch {{.SYNC_BRANCH}} already exists, deleting it."
            git branch -D {{.SYNC_BRANCH}}
            git checkout -b {{.SYNC_BRANCH}}

          # If branch does not exist - create new branch
          else
            git checkout -b {{.SYNC_BRANCH}}
          fi

          cd -
        done

  # ============================================================================
  # Commit and Push Tasks
  # ============================================================================

  push:
    desc: |
      Commit and push changes with the specified commit message.
      Example: `task os:push -- terraform-spacelift-automation`
    summary: |
      This will commit and push changes with the message "chore: update with the latest template state"
      for each of the specified Terraform module repositories.
      To push to a specific repository (or a custom list of repositories), pass their names as arguments:
      `task os:push -- terraform-custom-module`
      or for multiple modules: `task os:push -- "terraform-custom-module terraform-another-module"`

    vars:
      MODULES: "{{if .CLI_ARGS}}{{.CLI_ARGS}}{{else}}{{.DEFAULT_MODULES}}{{end}}"
    cmds:
      - |
        # Convert newlines to spaces and remove backslashes
        modules=$(echo "{{.MODULES}}" | tr '\n' ' ' | sed 's/\\//g')
        for module in $modules
        do
          echo "ðŸš€ Processing ../$module..."
          cd ../$module
          echo "ðŸ”„ Checking out {{.SYNC_BRANCH}} branch..."
          git checkout {{.SYNC_BRANCH}}
          echo "ðŸ“ Staging changes..."
          git add .

          # Check if there are any changes to commit
          if git diff --staged --quiet; then
            echo "âš ï¸  No changes to commit in $module, skipping..."
          else
            echo "ðŸ“ Committing changes..."
            git commit -m "{{.SYNC_MESSAGE}}"
            echo "â¬†ï¸ Pushing changes..."
            git push origin {{.SYNC_BRANCH}}
          fi
          cd -
        done

  # ============================================================================
  # Pull Request Management Tasks
  # ============================================================================

  pr:
    desc: |
      Create pull requests for the changes pushed to SYNC_BRANCH.
      Example: `task os:pr -- terraform-spacelift-automation`
    summary: |
      This will create pull requests from the SYNC_BRANCH to main for each of the specified
      Terraform module repositories using GitHub CLI.
      To create PRs for specific repositories, pass their names as arguments:
      `task os:pr -- terraform-custom-module`
      or for multiple modules: `task os:pr -- "terraform-custom-module terraform-another-module"`

    vars:
      MODULES: "{{if .CLI_ARGS}}{{.CLI_ARGS}}{{else}}{{.DEFAULT_MODULES}}{{end}}"
    cmds:
      - |
        # Get the latest commit SHA from terraform-module-template
        echo "ðŸ” Fetching latest commit SHA from terraform-module-template..."
        template_sha=$(git ls-remote {{.TEMPLATE_REPO}} HEAD | cut -f1)
        template_short_sha=$(echo $template_sha | cut -c1-7)

        # Try to get the latest tag from terraform-module-template
        echo "ðŸ·ï¸  Fetching latest tag from terraform-module-template..."
        template_tag=$(git ls-remote --tags --sort=-version:refname {{.TEMPLATE_REPO}} | head -n1 | sed 's/.*refs\/tags\///' | sed 's/\^{}//')

        # If no tag found, use "no tags"
        if [ -z "$template_tag" ]; then
          template_tag="no tags"
        fi

        echo "ðŸ“ Template info: Tag: $template_tag, SHA: $template_short_sha"

        # Convert newlines to spaces and remove backslashes
        modules=$(echo "{{.MODULES}}" | tr '\n' ' ' | sed 's/\\//g')
        for module in $modules
        do
          echo "ðŸš€ Creating PR for ../$module..."
          cd ../$module

          current_branch=$(git branch --show-current)
          if [ "$current_branch" != "{{.SYNC_BRANCH}}" ]; then
            echo "âš ï¸  Warning: Not on {{.SYNC_BRANCH}} branch. Current branch: $current_branch"
            echo "ðŸ”„ Checking out {{.SYNC_BRANCH}}..."
            git checkout {{.SYNC_BRANCH}}
          fi

          # Check if there are commits ahead of main
          commits_ahead=$(git rev-list --count main..{{.SYNC_BRANCH}})
          if [ "$commits_ahead" -eq 0 ]; then
            echo "â­ï¸  No commits ahead of main, skipping PR creation for $module"
            cd -
            continue
          fi

          # Ensure remote branch exists
          if ! git ls-remote --heads origin {{.SYNC_BRANCH}} | grep -q {{.SYNC_BRANCH}}; then
            echo "ðŸ“¤ Remote branch doesn't exist, pushing {{.SYNC_BRANCH}} to origin..."
            git push origin {{.SYNC_BRANCH}}
          fi

          # Check if PR already exists
          existing_pr=$(gh pr list --head {{.SYNC_BRANCH}} --base main --json number --jq '.[0].number' 2>/dev/null || echo "")
          if [ -n "$existing_pr" ]; then
            echo "ðŸ“‹ PR already exists (#$existing_pr), skipping PR creation for $module"
            cd -
            continue
          fi

          # Create PR body with template version info
          echo "ðŸ“‹ Creating pull request..."

          # Create PR body using printf to properly handle multi-line formatting
          pr_body=$(printf "%s\n\n%s\n%s\n%s\n\n%s\n%s\n%s\n%s\n%s" \
            "This PR syncs the repository with the latest state from [terraform-module-template]({{.TEMPLATE_REPO}})." \
            "**Template Version:**" \
            "- **Tag:** [$template_tag]({{.TEMPLATE_REPO}}/releases/tag/$template_tag)" \
            "- **Commit SHA:** $template_short_sha" \
            "**Changes include:**" \
            "- Updated configuration files (.checkov.yaml, .markdownlint.yaml, etc.)" \
            "- Updated GitHub workflows and templates" \
            "- Updated linting and formatting configurations" \
            "- Updated documentation templates")

          gh pr create \
            --title "{{.SYNC_MESSAGE}}" \
            --body "$pr_body" \
            --base main \
            --head {{.SYNC_BRANCH}} \
            --repo "{{.TEMPLATE_OWNER}}/$module"

          cd -
        done

  # ============================================================================
  # Template Management Tasks
  # ============================================================================

  setup-template:
    desc: Set up the template repository in a shared temporary directory
    cmds:
      - task: cleanup-template
      - git clone --depth 1 {{.TEMPLATE_REPO}} {{.SHARED_TMP_DIR}}

  cleanup-template:
    desc: Clean up the shared temporary directory
    cmds:
      - rm -rf {{.SHARED_TMP_DIR}}

  # ============================================================================
  # Composite Workflow Tasks
  # ============================================================================

  sync-all:
    desc: |
      Pull main branch, create a sync branch, and sync with template for specified Terraform open-source module repos.
      Example: `task os:sync-all -- terraform-spacelift-automation`
    summary: |
      This will:
      1. Pull the main branch and create a new branch named 'chore/sync-with-template'
      2. Sync files from the template repository
      for each of the default Terraform module repositories listed in DEFAULT_MODULES.
      To sync to a specific repository (or a custom list of repositories), pass their names as arguments:
      `task os:sync-all -- terraform-custom-module`
      or for multiple modules: `task os:sync-all -- "terraform-custom-module terraform-another-module"`

    vars:
      MODULES: "{{if .CLI_ARGS}}{{.CLI_ARGS}}{{else}}{{.DEFAULT_MODULES}}{{end}}"
      DELETE_EXISTING_SYNC_BRANCH: "{{.DELETE_EXISTING_SYNC_BRANCH | default false}}"
    cmds:
      - task: setup-template
      - task: pull-and-branch
      - task: sync
      - task: cleanup-template

  sync-and-pr:
    desc: |
      Complete workflow: sync with template, push changes, and create pull requests.
      Example: `task os:sync-and-pr -- terraform-spacelift-automation`
    summary: |
      This will:
      1. Pull the main branch and create a new branch named 'chore/sync-with-template'
      2. Sync files from the template repository
      3. Commit and push changes
      4. Create pull requests for the changes
      for each of the default Terraform module repositories listed in DEFAULT_MODULES.
      To sync to a specific repository (or a custom list of repositories), pass their names as arguments:
      `task os:sync-and-pr -- terraform-custom-module`
      or for multiple modules: `task os:sync-and-pr -- "terraform-custom-module terraform-another-module"`

    vars:
      MODULES: "{{if .CLI_ARGS}}{{.CLI_ARGS}}{{else}}{{.DEFAULT_MODULES}}{{end}}"
      DELETE_EXISTING_SYNC_BRANCH: "{{.DELETE_EXISTING_SYNC_BRANCH | default false}}"
    cmds:
      - task: sync-all
      - task: push
      - task: pr
